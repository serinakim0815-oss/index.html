<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Masked-only Preview — Numbered Sections + Dropbox Upload (Refresh Token)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.75; color:#222; }
    .container { max-width: 1040px; margin: 0 auto; }
    h1 { font-size: 22px; margin-bottom: 8px; }
    .controls { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; align-items:end; margin:14px 0; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#555; }
    .span-4 { grid-column: span 4; min-width: 220px; }
    .span-3 { grid-column: span 3; min-width: 180px; }
    .span-2 { grid-column: span 2; min-width: 140px; }

    input[type="file"], select, input[type="text"], input[type="email"] {
      padding:8px 12px; border:1px solid #ddd; border-radius:10px; background:#fff;
    }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    button:hover:enabled { filter:brightness(0.98); }
    .box { border:1px solid #eee; border-radius:14px; padding:14px; margin:14px 0; background:#fff; }
    .page { margin:14px 0 18px; }
    .page h3 { margin:0 0 10px; font-size:15px; color:#444; }
    .preview { background:#fafafa; border:1px solid #eee; border-radius:12px; padding:18px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); white-space:pre-wrap; }
    .preview p { margin:0 0 12px; }
    .preview h4 { font-size:16px; margin:16px 0 8px; color:#222; }
    .preview ul, .preview ol { margin: 0 0 12px 22px; padding: 0; }
    .preview li { margin: 4px 0; }
    .section { padding: 8px 0; border-top: 1px dashed #eee; }
    .section:first-child { border-top: 0; }
    .muted { color:#666; font-size:13px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0; }
    .chip { background:#f4f6ff; border:1px solid #e1e6ff; border-radius:999px; padding:4px 8px; font-size:12px; }
    .red { color: red; }
    /* brand logo */
    .brand { display:flex; justify-content:center; align-items:center; margin: 10px 0 12px; }
    .brand img { max-height: 80px; width: auto; max-width: 100%; }
    .center { text-align:center; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
</head>
<body>
<div class="container">
  <div class="brand">
    <img src="./mbaisystem_logo.jpg" alt="Company Logo" />
  </div>
  <h1 class="center">Preview Masked Results</h1>
  <div class="muted center">Numbered Sections · Mask Addresses, Contacts, Emails & Amounts · Dropbox Upload (auto refresh)</div>

  <div class="controls box">
    <div class="field span-4">
      <label for="fileInput">Choose File (PDF/TXT)</label>
      <input type="file" id="fileInput" accept=".pdf,.txt,text/plain,application/pdf" />
    </div>

    <div class="field span-3">
      <label for="email">Client Email (필수, 파일명에 포함)</label>
      <input type="email" id="email" placeholder="client@example.com" required />
    </div>

    <div class="field span-3">
      <label for="mode">Masking Mode</label>
      <select id="mode">
        <option value="stars" selected>Asterisk Masking(*)</option>
        <option value="partial">Partial Masking (Preserve Last Digits)</option>
        <option value="token">Token Replacement ([EMAIL])</option>
      </select>
    </div>

    <div class="field span-2">
      <label>&nbsp;</label>
      <button id="btnProcess" type="button">Process</button>
    </div>

    <div class="field span-2">
      <label>&nbsp;</label>
      <button id="btnSend" type="button" disabled>Send (Dropbox)</button>
    </div>
  </div>

  <div class="box">
    <b>Tag Statistics</b>
    <div id="stats" class="chips"></div>
  </div>

  <div id="pages" class="box">
    <div class="page">
      <h3>Preview</h3>
      <div class="preview">Please select a file and then click 'Process'.</div>
    </div>
  </div>
</div>

<script>
const escapeHTML = (s) => s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

async function extractTextPages(file){
  const name=(file.name||'').toLowerCase();
  const isPDF=name.endsWith('.pdf')||file.type==='application/pdf';
  if(!isPDF){ return [await file.text()]; }
  if (!window.pdfjsLib || !pdfjsLib.getDocument) {
    try { return [await file.text()]; } catch(e){ throw new Error('PDF.js 불러오기 실패'); }
  }
  try {
    if (!pdfjsLib.GlobalWorkerOptions?.workerSrc) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    const pages=[];
    for (let p=1; p<=pdf.numPages; p++){
      const page=await pdf.getPage(p);
      const content=await page.getTextContent();
      const text=(content.items||[]).map(i=>i.str||'').join(' ')+'\n';
      pages.push(text);
    }
    return pages;
  } catch (err) {
    console.error('PDF 파싱 실패:', err);
    try { const textFallback = await file.text(); return [textFallback]; }
    catch { throw new Error('PDF를 읽을 수 없습니다.'); }
  }
}

function buildStructuredHTML(txt){
  return escapeHTML(txt);
}

(function(){
  const $ = id=>document.getElementById(id);
  let lastMaskedAll='';

  function checkEmailValidity(){
    const emailField = $('email');
    const sendBtn = $('btnSend');
    if (emailField && sendBtn){
      if (emailField.validity.valid && emailField.value.trim() !== '' && lastMaskedAll){
        sendBtn.disabled=false;
      } else {
        sendBtn.disabled=true;
      }
    }
  }

  $('email').addEventListener('input', checkEmailValidity);

  $('btnProcess').addEventListener('click', async()=>{
    const file=($('fileInput').files||[])[0];
    if(!file){ alert('파일 선택 필요'); return; }
    $('pages').innerHTML='<div class="page"><div class="preview">처리중...</div></div>';
    const pages=await extractTextPages(file);
    let joined=[];
    $('pages').innerHTML='';
    pages.forEach((t,idx)=>{
      const page=document.createElement('div'); page.className='page';
      const h=document.createElement('h3'); h.textContent='페이지 '+(idx+1);
      const pre=document.createElement('div'); pre.className='preview'; pre.innerHTML=buildStructuredHTML(t);
      page.appendChild(h); page.appendChild(pre); $('pages').appendChild(page);
      joined.push(t);
    });
    lastMaskedAll=joined.join('\n---- PAGE SEP ----\n');
    window.lastMaskedAll=lastMaskedAll;
    checkEmailValidity();
  });
})();
</script>
</body>
</html>
